<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IRANCASH | Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <!-- Estilos compartilhados do projeto (seu app.css existente) -->
  <link rel="stylesheet" href="css/app.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card-hover{ transition: transform .18s ease, box-shadow .18s ease; }
    .card-hover:hover{ transform: translateY(-4px); box-shadow: 0 10px 22px rgba(2,6,23,0.10); }
    .sidebar-link{ display:flex; align-items:center; gap:.75rem; padding:.6rem 1rem; border-radius:.65rem; transition: background-color .18s, box-shadow .18s, transform .18s; font-size:.95rem;}
    .sidebar-link:hover{ background:#f1f5f9; }
    .sidebar-link.active{ background:#e6f4ff; box-shadow: inset 0 0 0 1px rgba(14,165,233,0.25); }
    .sidebar-icon{ width:18px; height:18px; }
  /* aumentar largura máxima do dashboard para melhor uso do espaço em telas grandes */
  .container-max{ max-width: 1560px; }
    /* months carousel wrapper and pills */
    .months-wrap{ position: relative; }
    .months-scroll{ display:flex; gap:1rem; overflow-x:auto; padding-bottom:0.5rem; scroll-behavior:smooth; }
  .month-pill{ min-width: 220px; width:220px; max-width:240px; cursor:pointer; }
  .month-pill:focus{ outline: 3px solid rgba(14,165,233,0.15); outline-offset: 4px; }
  .month-pill.selected{ box-shadow: 0 6px 18px rgba(2,6,23,0.08); border: 1px solid rgba(14,165,233,0.16); }
    .scrollbar-thin::-webkit-scrollbar{ height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:10px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="sidebar-collapsed bg-white shadow-lg flex flex-col lg:sticky lg:top-0 lg:h-screen lg:overflow-y-auto lg:z-10">
    <div class="flex items-center gap-2 px-6 py-6 border-b">
  <img class="sidebar-logo" src="assets/irancash-logo.png" alt="IRANCASH logo" loading="lazy" decoding="async" />
      <span class="logo-text text-xl font-bold text-sky-600">IRANCASH</span>
    </div>
    <nav class="flex-1 px-4 py-6 space-y-2">
      <a href="index.html" class="sidebar-link active" aria-current="page">
      <img class="sidebar-icon-img" src="assets/dashboard-symbol.png" alt="Dashboard" loading="lazy" decoding="async" />
        <span>Dashboard</span>
      </a>
      <!-- Importar link removed (functionality moved to receitas.html) -->
    <a href="receitas.html" class="sidebar-link">
  <img class="sidebar-icon-img" src="assets/receitas-symbol.png" alt="Receitas" loading="lazy" decoding="async" />
        <span>Receitas</span>
      </a>
      <a href="despesas.html" class="sidebar-link">
        <img class="sidebar-icon-img" src="assets/despesas-symbol.png" alt="Despesas" />
        <span>Despesas</span>
      </a>
      <a href="ajuda.html" class="sidebar-link">
        <img class="sidebar-icon-img" src="assets/ajuda-icone.png" alt="Ajuda" />
        <span>Ajuda</span>
      </a>
      <a href="configuracoes.html" class="sidebar-link">
        <img class="sidebar-icon-img" src="assets/configuracao-symbol.png" alt="Configurações" />
        <span>Configurações</span>
      </a>
    </nav>
    <div class="px-6 py-4 border-t text-xs text-gray-400">
      &copy; 2025 IRANCASH
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-8 lg:pl-12">
    <div class="mx-auto container-max">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl lg:text-3xl font-bold text-gray-800">Dashboard</h1>
        <div class="flex items-center gap-2">
          <label for="anoSelect" class="text-sm text-gray-600">Ano:</label>
          <select id="anoSelect" class="border rounded px-2 py-1 text-sm"></select>
        </div>
      </div>

      <!-- CARDS MENSAIS (scroll horizontal) with prev/next buttons -->
      <div class="months-wrap mb-6">
        <button id="mesPrev" aria-label="Anterior" class="absolute left-0 top-1/2 -translate-y-1/2 -ml-2 bg-white shadow rounded-full p-2 z-10 hidden sm:flex items-center justify-center" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="#0ea5e9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <div id="cardsMeses" class="months-scroll scrollbar-thin px-1 py-1"></div>

        <button id="mesNext" aria-label="Próximo" class="absolute right-0 top-1/2 -translate-y-1/2 -mr-2 bg-white shadow rounded-full p-2 z-10 hidden sm:flex items-center justify-center" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="#0ea5e9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <!-- LINHA 2: RESUMO + COMPARAÇÃO + DESPESAS FUTURAS -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Card: Até o momento -->
        <div class="bg-white rounded-lg shadow p-5 card-hover h-full flex flex-col">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold text-gray-800 mb-1">Até o momento</h2>
              <div id="tituloMesAtual" class="text-sm text-gray-500">-</div>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
            <div class="space-y-3">
              <div class="flex items-center justify-between bg-green-50 rounded-lg px-3 py-2">
                <div>
                  <div class="text-green-700 font-semibold">Entrou</div>
                  <div class="text-xs text-gray-500">Receitas</div>
                </div>
                <div id="valorReceitaAtual" class="text-gray-900 font-bold">R$ 0,00</div>
              </div>

              <div class="flex items-center justify-between bg-red-50 rounded-lg px-3 py-2">
                <div>
                  <div class="text-red-600 font-semibold">Saiu</div>
                  <div class="text-xs text-gray-500">Despesas</div>
                </div>
                <div id="valorDespesaAtual" class="text-gray-900 font-bold">R$ 0,00</div>
              </div>

              <div class="flex items-center justify-between bg-slate-50 rounded-lg px-3 py-2">
                <div>
                  <div class="text-slate-700 font-semibold">Sobrou</div>
                  <div class="text-xs text-gray-500">Saldo</div>
                </div>
                <div id="valorLucroAtual" class="text-gray-900 font-bold">R$ 0,00</div>
              </div>

              <p class="text-xs text-gray-500 pt-2">
                *Valores refletem apenas movimentações da operação.
              </p>
            </div>

            <div class="flex items-center justify-center">
              <canvas id="pizzaAtual" width="220" height="220" style="max-width:220px;max-height:220px;"></canvas>
            </div>
          </div>
        </div>

        <!-- Card: Comparação -->
        <div class="bg-white rounded-lg shadow p-5 card-hover h-full flex flex-col">
          <div>
            <h2 class="text-xl font-bold text-gray-800 mb-1">Comparação</h2>
            <div class="text-sm text-gray-500 mb-3">com o período anterior</div>
            <canvas id="comparacaoChart" height="230"></canvas>
          </div>
        </div>

        <!-- Card: Despesas futuras (mês selecionado) -->
        <div class="bg-white rounded-lg shadow p-5 card-hover h-full flex flex-col">
          <div>
            <h3 class="text-lg font-bold text-gray-800">Despesas futuras</h3>
            <div class="text-sm text-gray-500">Despesas Futuras do mês selecionado</div>

            <div id="paraAcontecerList" class="mt-4 space-y-2 min-h-[72px]"></div>
          </div>

          <div class="border-t mt-4 pt-3 flex items-center justify-between mt-auto">
            <div class="text-sm font-semibold text-gray-700">Saldo total:</div>
            <div id="paraAcontecerSaldo" class="text-xl font-bold text-gray-800">R$ 0,00</div>
          </div>
        </div>
      </div>

      <!-- Linha: Fluxo financeiro + Vendas por Dia da Semana -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <!-- Card: Fluxo financeiro (últimos 6 meses) -->
        <div class="bg-white rounded-lg shadow p-5 card-hover">
          <h2 class="text-xl font-bold text-gray-800 mb-1">Fluxo financeiro</h2>
          <div class="text-sm text-gray-500 mb-3">evolução financeira dos últimos 6 meses</div>
          <canvas id="fluxoChart" height="150"></canvas>
        </div>

        <!-- Card: Vendas por Dia da Semana -->
        <div class="bg-white rounded-lg shadow p-5 card-hover">
          <h2 class="text-xl font-bold text-gray-800 mb-1">Vendas por Dia da Semana</h2>
          <div class="text-sm text-gray-500 mb-3">soma da receita bruta por dia da semana para o mês selecionado</div>
          <canvas id="vendasDiaSemanaChart" height="150"></canvas>
        </div>
      </div>

      <!-- Ações rápidas -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
  <a href="receitas.html" class="bg-sky-600 hover:bg-sky-700 text-white rounded-lg p-4 flex items-center gap-3 transition card-hover">
          <svg width="32" height="32" fill="none"><path d="M16 4v16m0 0l-6-6m6 6l6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="20" width="24" height="8" rx="2" fill="white" fill-opacity="0.2"/></svg>
          <span class="text-md font-semibold">Importar Dados</span>
        </a>
        <a href="despesas.html" class="bg-red-500 hover:bg-red-600 text-white rounded-lg p-4 flex items-center gap-3 transition card-hover">
          <svg width="32" height="32" fill="none"><path d="M8 16h16M16 8v16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="text-md font-semibold">Adicionar Despesa</span>
        </a>
      </div>
    </div>
  </main>
  <script>
    // -------- Helpers --------
    const PT_MESES = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

    function numBR(n){ return Number(n||0).toLocaleString('pt-BR', {minimumFractionDigits:2}); }
    function fmtBR(n){ return 'R$ ' + numBR(n); }

    function lerVendasResumo(){
      try { return JSON.parse(localStorage.getItem('vendasResumo')) || []; }
      catch(e){ console.warn('Erro lendo vendasResumo', e); return []; }
    }

    // -------- Card "Fluxo financeiro" (últimos 6 meses) --------
    let fluxoInstance = null;
    function atualizarFluxoFinanceiro(){
      // referência: sempre usar o mês/ano atual — não depende da seleção dos cards
      const hoje = new Date();
      const anoRef = hoje.getFullYear();
      const mRef = hoje.getMonth();

      // calcular intervalo de 6 meses (incluir mês atual de referência)
      const start = new Date(Number(anoRef), Number(mRef) - 5, 1); // 5 meses antes
      const labels = [];
      const receitas = [];
      const gastos = [];
      const consolidados = [];

      for (let i = 0; i < 6; i++){
        const d = new Date(start.getFullYear(), start.getMonth() + i, 1);
        const y = d.getFullYear();
        const m = d.getMonth();
        labels.push(`${PT_MESES[m].slice(0,3)} ${String(y).slice(-2)}`);
        const r = receitaBrutaMes(String(y), m);
        const g = despesaMes(String(y), m);
        receitas.push(r);
        gastos.push(g);
        consolidados.push(r - g);
      }

      const el = document.getElementById('fluxoChart');
      if (!el) return;
      const ctx = el.getContext('2d');
      if (fluxoInstance) fluxoInstance.destroy();
      fluxoInstance = new Chart(ctx, {
        data: {
          labels,
          datasets: [
            { type: 'bar', label: 'Receita', data: receitas, backgroundColor: '#10b981' },
            { type: 'bar', label: 'Gasto',   data: gastos,   backgroundColor: '#ef4444' },
            { type: 'line', label: 'Consolidado', data: consolidados, borderColor: '#7dd3fc', backgroundColor: 'rgba(125,211,252,0.18)', fill: true, tension: 0.3, pointRadius: 3 }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: true } }
        }
      });
    }
    function lerDespesas(){
      try { return JSON.parse(localStorage.getItem('despesas')) || []; }
      catch(e){ console.warn('Erro lendo despesas', e); return []; }
    }

    function anoDe(anoMes){ return String(anoMes || '').split('/')[0] || ''; }
    function mesNumDe(anoMes){
      const m = String(anoMes||'').split('/')[1];
      const n = Number(m);
      return (Number.isInteger(n) && n>=1 && n<=12) ? n-1 : null;
    }

    // Totais por mês
    function receitaBrutaMes(ano, mIdx){
      const dados = lerVendasResumo();
      let total = 0;
      for (const v of dados){
        if (!v.anoMes) continue;
        if (anoDe(v.anoMes) !== String(ano)) continue;
        const mi = mesNumDe(v.anoMes);
        if (mi === mIdx) total += Number(v.receitaBruta || 0);
      }
      return total;
    }

  // Sidebar navigation logic extracted to `js/sidebar-nav.js` (loaded below)
    function despesaMes(ano, mIdx){
      const dados = lerDespesas();
      let total = 0;
      const nomeMes = PT_MESES[mIdx];
      for (const d of dados){
        if (String(d.ano) !== String(ano)) continue;
        if (String(d.mes) !== String(nomeMes)) continue;
        total += Number(d.valor || 0);
      }
      return total;
    }

    function anosDisponiveis(){
      const anos = new Set();
      for (const v of lerVendasResumo()){ if (v.anoMes) anos.add(anoDe(v.anoMes)); }
      for (const d of lerDespesas()){ if (d.ano) anos.add(String(d.ano)); }
      const arr = Array.from(anos).filter(Boolean).sort((a,b)=>Number(a)-Number(b));
      if (arr.length === 0) arr.push(String(new Date().getFullYear()));
      return arr;
    }

    // -------- UI: Ano + Cards --------
    const anoSelect = document.getElementById('anoSelect');
    const cardsMeses = document.getElementById('cardsMeses');

    function montarAnoSelect(){
      anoSelect.innerHTML = '';
      for (const a of anosDisponiveis()){
        const opt = document.createElement('option');
        opt.value = a; opt.textContent = a;
        anoSelect.appendChild(opt);
      }
      const atual = String(new Date().getFullYear());
      if ([...anoSelect.options].some(o => o.value === atual)) anoSelect.value = atual;
    }

    // selected month/year set by clicking a card. If null -> dashboard shows current month (or anoSelect value for year)
    let selectedYear = null;
    let selectedMonthIndex = null;

    function setSelectedMonth(year, mIdx){
      selectedYear = String(year);
      selectedMonthIndex = (mIdx === null || mIdx === undefined) ? null : Number(mIdx);
      // highlight card
      for (const c of Array.from(cardsMeses.children)){
        if (!c.dataset) continue;
        const cy = c.dataset.year;
        const cm = Number(c.dataset.month);
        if (selectedYear && cm === selectedMonthIndex && String(cy) === String(selectedYear)) c.classList.add('selected');
        else c.classList.remove('selected');
      }
      // refresh charts for new selection (não altera o fluxo financeiro que sempre mostra últimos 6 meses a partir do mês atual)
      atualizarResumoAtual();
      atualizarComparacao();
      atualizarParaAcontecer();
      atualizarVendasPorDiaSemana();
    }

    function montarCardsMeses(){
      const ano = anoSelect.value || String(new Date().getFullYear());
      cardsMeses.innerHTML = '';

      PT_MESES.forEach((nome, idx) => {
        const r = receitaBrutaMes(ano, idx);
        const d = despesaMes(ano, idx);

        const card = document.createElement('div');
        card.className = "month-pill bg-white rounded-xl shadow p-4 flex flex-col justify-between card-hover";
        card.setAttribute('role','button');
        card.setAttribute('tabindex','0');
        card.dataset.month = String(idx);
        card.dataset.year = String(ano);
        card.innerHTML = `
          <div class="text-gray-500 text-sm">${nome.slice(0,3)} ${String(ano).slice(-2)}</div>
          <div class="mt-2 space-y-1">
            <div class="flex items-center gap-2 text-sm">
              <span class="inline-flex items-center justify-center rounded-full bg-green-100 text-green-700 w-5 h-5">↑</span>
              <span class="text-gray-700">Receita</span>
              <span class="ml-auto font-semibold text-gray-900">${fmtBR(r)}</span>
            </div>
            <div class="flex items-center gap-2 text-sm">
              <span class="inline-flex items-center justify-center rounded-full bg-red-100 text-red-600 w-5 h-5">↓</span>
              <span class="text-gray-700">Despesa</span>
              <span class="ml-auto font-semibold text-gray-900">${fmtBR(d)}</span>
            </div>
          </div>
        `;

        // click / keyboard support: set selection to this month
        card.addEventListener('click', ()=> setSelectedMonth(ano, idx));
        card.addEventListener('keydown', (e)=> { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setSelectedMonth(ano, idx); } });

        // if currently selected, mark
        if (selectedYear && selectedMonthIndex !== null && Number(selectedMonthIndex) === idx && String(selectedYear) === String(ano)){
          card.classList.add('selected');
        }

        cardsMeses.appendChild(card);
      });
    }

    // -------- Card "Até o momento" + Pizza --------
    let pizzaInstance = null;
    function atualizarResumoAtual(){
      // if user selected a month, show that; otherwise use current month
      const hoje = new Date();
      const ano = selectedYear || anoSelect.value || hoje.getFullYear();
      const mIdx = (selectedMonthIndex !== null && selectedMonthIndex !== undefined) ? Number(selectedMonthIndex) : hoje.getMonth();

      const rec = receitaBrutaMes(ano, mIdx);
      const des = despesaMes(ano, mIdx);
      const luc = rec - des;

      document.getElementById('tituloMesAtual').textContent = `${PT_MESES[mIdx].slice(0,3)} ${String(ano).slice(-2)}`;
      document.getElementById('valorReceitaAtual').textContent = fmtBR(rec);
      document.getElementById('valorDespesaAtual').textContent = fmtBR(des);
      document.getElementById('valorLucroAtual').textContent = fmtBR(luc);

      const ctx = document.getElementById('pizzaAtual').getContext('2d');
      if (pizzaInstance) pizzaInstance.destroy();
      pizzaInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Receita', 'Despesa', 'Lucro'],
          datasets: [{
            data: [rec, des, Math.max(luc, 0)],
            backgroundColor: ['#10b981','#ef4444','#0ea5e9']
          }]
        },
        options: { plugins: { legend: { display: true } } }
      });
    }

    // -------- Card "Comparação" --------
    let compInstance = null;
    function atualizarComparacao(){
      // if user selected a month, compare that month with its previous month; otherwise use current month
      const hoje = new Date();
      const anoAtual = selectedYear || anoSelect.value || hoje.getFullYear();
      const mAtual = (selectedMonthIndex !== null && selectedMonthIndex !== undefined) ? Number(selectedMonthIndex) : hoje.getMonth();

      // mês anterior (ajusta ano se necessário)
      const prevDate = new Date(Number(anoAtual), mAtual, 1);
      prevDate.setMonth(prevDate.getMonth() - 1);
      const anoPrev = prevDate.getFullYear();
      const mPrev = prevDate.getMonth();

      const recAtual = receitaBrutaMes(anoAtual, mAtual);
      const desAtual = despesaMes(anoAtual, mAtual);
      const recPrev  = receitaBrutaMes(anoPrev, mPrev);
      const desPrev  = despesaMes(anoPrev, mPrev);

      const ctx = document.getElementById('comparacaoChart').getContext('2d');
      if (compInstance) compInstance.destroy();
      compInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [ `${PT_MESES[mPrev].slice(0,3)} ${String(anoPrev).slice(-2)}`, `${PT_MESES[mAtual].slice(0,3)} ${String(anoAtual).slice(-2)}` ],
          datasets: [
            { label: 'Entrou (Receita)', data: [recPrev, recAtual], backgroundColor: '#10b981' },
            { label: 'Saiu (Despesa)',  data: [desPrev, desAtual], backgroundColor: '#ef4444' }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: true } }
        }
      });
    }

    // -------- Card "Despesas futuras" (mês selecionado) --------
    function atualizarParaAcontecer(){
      const listaEl = document.getElementById('paraAcontecerList');
      const saldoEl = document.getElementById('paraAcontecerSaldo');
      if (!listaEl || !saldoEl) return;

      const hoje = new Date();
      // determinar mês/ano de referência: preferir seleção do card, senão mês atual
      const anoRef = selectedYear || String(hoje.getFullYear());
      const mRef = (selectedMonthIndex !== null && selectedMonthIndex !== undefined) ? Number(selectedMonthIndex) : hoje.getMonth();

      const despesas = lerDespesas() || [];
      const lista = [];

      for (const d of despesas){
        try {
          const anoD = String(d.ano);
          const mesD = String(d.mes);
          const mIdx = PT_MESES.indexOf(mesD);
          if (mIdx === -1) continue;
          // excluir taxas de vendas / MDR
          const cat = String(d.categoria || d.descricao || '').toLowerCase();
          if (cat.includes('mdr') || cat.includes('taxas de vendas')) continue;
          if (String(anoRef) !== String(anoD)) continue;
          if (Number(mRef) !== Number(mIdx)) continue;

          // se o mês selecionado for o mês atual, listar apenas despesas com dia >= hoje (ou sem dia definido)
          const dia = (d.dia === null || d.dia === undefined || d.dia === '') ? null : Number(d.dia);
          const isMesAtual = (Number(anoRef) === hoje.getFullYear() && Number(mRef) === hoje.getMonth());
          if (isMesAtual && dia !== null){
            if (dia < hoje.getDate()) continue; // já vencido no mês atual
          }

          lista.push({ descricao: d.descricao || d.categoria || 'Despesa', valor: Number(d.valor || 0), dia });
        } catch (e) { /* ignorar item mal formado */ }
      }

      // ordenar por dia (nulls no final)
      lista.sort((a,b)=>{ if (a.dia === null) return 1; if (b.dia === null) return -1; return a.dia - b.dia; });

      listaEl.innerHTML = '';
      if (lista.length === 0){
        listaEl.innerHTML = '<div class="text-sm text-gray-500">Nenhuma despesa pendente para o mês selecionado.</div>';
      } else {
        for (const it of lista){
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between text-sm';
          const left = document.createElement('div');
          left.className = 'flex items-center gap-2 text-gray-700';
          const dot = document.createElement('span'); dot.className = 'inline-block w-2 h-2 rounded-full mr-2 bg-red-500';
          left.appendChild(dot);
          const desc = document.createElement('div'); desc.textContent = it.descricao + (it.dia ? ` • dia ${it.dia}` : '');
          left.appendChild(desc);

          const val = document.createElement('div'); val.className = 'font-semibold text-red-600'; val.textContent = fmtBR(-Math.abs(it.valor));

          row.appendChild(left);
          row.appendChild(val);
          listaEl.appendChild(row);
        }
      }

      // soma total (mostrar negativo como na UI exemplo)
      const soma = lista.reduce((s,it)=> s + Number(it.valor || 0), 0);
      saldoEl.textContent = fmtBR(-Math.abs(soma));
      if (soma > 0) saldoEl.classList.add('text-red-600'); else saldoEl.classList.remove('text-red-600');
    }

    // -------- Card "Vendas por Dia da Semana" --------
    let vendasDiaSemanaInstance = null;
    function parseVendaDate(v){
      // tenta várias chaves possíveis: data (ISO), date, createdAt, dia + anoMes
      try {
        if (!v) return null;
        if (v.data) return new Date(v.data);
        if (v.date) return new Date(v.date);
        if (v.createdAt) return new Date(v.createdAt);
        // se houver dia separado e anoMes (YYYY/MM) combinar
        if (v.dia != null && v.anoMes){
          const parts = String(v.anoMes).split('/');
          if (parts.length >= 2){
            const y = Number(parts[0]);
            const m = Number(parts[1]) - 1;
            const day = Number(v.dia);
            if (!Number.isNaN(y) && !Number.isNaN(m) && !Number.isNaN(day)) return new Date(y, m, day);
          }
        }
        // alguns registros podem ter ano, mes, dia separados
        if (v.ano && v.mes && v.dia){
          const y = Number(v.ano);
          const m = PT_MESES.indexOf(String(v.mes));
          const day = Number(v.dia);
          if (m !== -1) return new Date(y, m, day);
        }
      } catch(e){ return null; }
      return null;
    }

    function atualizarVendasPorDiaSemana(){
      const ctxEl = document.getElementById('vendasDiaSemanaChart');
      if (!ctxEl) return;

      const hoje = new Date();
      const anoRef = selectedYear || String(hoje.getFullYear());
      const mRef = (selectedMonthIndex !== null && selectedMonthIndex !== undefined) ? Number(selectedMonthIndex) : hoje.getMonth();

      const vendas = lerVendasResumo() || [];
      // iniciar contadores para 0..6 (domingo=0)
      const totals = [0,0,0,0,0,0,0];

      for (const v of vendas){
        try {
          // garantir que a venda pertence ao mês/ano referenciado
          // se v.anoMes estiver presente, usar; senão tentar parseVendaDate
          if (v.anoMes){
            const parts = String(v.anoMes).split('/');
            const y = Number(parts[0]);
            const m = Number(parts[1]) - 1;
            if (String(y) !== String(anoRef) || Number(m) !== Number(mRef)) continue;
            // tentar obter dia para construir Date e descobrir weekday
            let date = null;
            if (v.dia != null) { date = new Date(y, m, Number(v.dia)); }
            else if (v.data) date = new Date(v.data);
            // se não tiver dia, assumir que não é possível contar por weekday — pular
            if (!date) continue;
            const wd = date.getDay();
            totals[wd] += Number(v.receitaBruta || 0);
          } else {
            // tentar parse completo de data
            const date = parseVendaDate(v);
            if (!date) continue;
            if (date.getFullYear() !== Number(anoRef) || date.getMonth() !== Number(mRef)) continue;
            const wd = date.getDay();
            totals[wd] += Number(v.receitaBruta || 0);
          }
        } catch(e){ /* ignorar registro */ }
      }

      const labels = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
      const ctx = ctxEl.getContext('2d');
      if (vendasDiaSemanaInstance) vendasDiaSemanaInstance.destroy();
      vendasDiaSemanaInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{ label: 'Receita Bruta (R$)', data: totals, backgroundColor: '#0ea5e9' }]
        },
        options: {
          indexAxis: 'y', // barras horizontais (lateral)
          responsive: true,
          scales: { x: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    }

    // -------- Boot --------
    function refreshAll(){
      montarCardsMeses();
      atualizarResumoAtual();
      atualizarComparacao();
      atualizarFluxoFinanceiro();
      atualizarParaAcontecer();
      atualizarVendasPorDiaSemana();
      // update arrows in case size changed after mounting cards
      setTimeout(updateArrowState, 120);
    }

    montarAnoSelect();
    refreshAll();

    // -------- Setas e scroll do carrossel de meses --------
    const mesPrev = document.getElementById('mesPrev');
    const mesNext = document.getElementById('mesNext');

    function scrollMonths(delta){
      if (!cardsMeses) return;
      cardsMeses.scrollBy({ left: delta, behavior: 'smooth' });
      // after animation settle, update arrows
      setTimeout(updateArrowState, 350);
    }

    function updateArrowState(){
      if (!cardsMeses || !mesPrev || !mesNext) return;
      const atStart = cardsMeses.scrollLeft <= 5;
      const atEnd = (cardsMeses.scrollWidth - cardsMeses.clientWidth - cardsMeses.scrollLeft) <= 5;
      mesPrev.disabled = atStart;
      mesNext.disabled = atEnd;
      mesPrev.classList.toggle('opacity-50', atStart);
      mesNext.classList.toggle('opacity-50', atEnd);

      // mostrar/ocultar setas em telas maiores apenas se houver overflow
      const hasOverflow = cardsMeses.scrollWidth > cardsMeses.clientWidth + 5;
      if (hasOverflow){ mesPrev.classList.remove('hidden'); mesNext.classList.remove('hidden'); }
      else { mesPrev.classList.add('hidden'); mesNext.classList.add('hidden'); }
    }

    if (mesPrev) mesPrev.addEventListener('click', ()=> scrollMonths(-260));
    if (mesNext) mesNext.addEventListener('click', ()=> scrollMonths(260));
    if (cardsMeses) cardsMeses.addEventListener('scroll', updateArrowState);
    window.addEventListener('resize', updateArrowState);

    // ligar atualização de UI ao refresh geral
    anoSelect.addEventListener('change', () => { refreshAll(); setTimeout(updateArrowState, 120); });
    window.addEventListener('storage', () => { refreshAll(); setTimeout(updateArrowState, 120); });

    // inicializa estado das setas
    setTimeout(updateArrowState, 200);
  </script>
  <!-- Load shared sidebar navigation logic -->
  <script src="js/sidebar-nav.js" defer></script>
</body>
</html>

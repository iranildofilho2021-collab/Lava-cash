<!DOCTYPE html> 
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lava-Cash | Despesas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/app.css">
  <!-- estilos compartilhados movidos para css/app.css -->
  <style>
    /* small visual polish for edit state */
    .valor-edit { transition: box-shadow .12s ease, transform .12s ease; }
    .valor-edit.ring-2 { box-shadow: 0 0 0 3px rgba(14,165,233,0.15); transform: translateY(-1px); }
    .btn-editar.editing svg { transform: rotate(-10deg) scale(1.05); transition: transform .18s ease; }
    .btn-ok { transition: opacity .12s ease; }
    .valor-text { transition: opacity .12s ease; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-48 lg:w-64 bg-white shadow-lg flex flex-col">
    <div class="flex items-center gap-2 px-6 py-6 border-b">
      <!-- Logo SVG -->
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
        <ellipse cx="16" cy="16" rx="14" ry="14" fill="#38bdf8"/>
        <path d="M16 6C19 12 26 13 16 26C6 13 13 12 16 6Z" fill="#0ea5e9"/>
      </svg>
      <span class="text-xl font-bold text-sky-600">Lava-Cash</span>
    </div>
    <nav class="flex-1 px-4 py-6 space-y-2">
      <a href="index.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h8V3H3v10zM3 21h8v-6H3v6zM13 21h8V11h-8v10zM13 3v6h8V3h-8z" fill="#0ea5e9"/></svg>
        <span>Dashboard</span>
      </a>
      <a href="importar.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v9" stroke="#0ea5e9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="#0ea5e9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Importar</span>
      </a>
      <a href="receitas.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v2M5 7h14M4 21h16v-8H4v8z" stroke="#10b981" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Receitas</span>
      </a>
      <a href="despesas.html" class="sidebar-link active" aria-current="page">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Despesas</span>
      </a>
      <a href="ajuda.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18h.01M12 14a4 4 0 1 0-4-4" stroke="#64748b" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Ajuda</span>
      </a>
      <a href="configuracoes.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="#0ea5e9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 4.28 18.9l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.66 0 1.27-.4 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.1 4.28l.06.06a1.65 1.65 0 0 0 1.82.33h.09C9.3 4.4 9.9 4 10.56 4H13.44c.66 0 1.27.4 1.51 1 .26.7.98 1.2 1.77 1.2h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 1 1 19.72 5.1l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09c0 .66.4 1.27 1 1.51H21a2 2 0 1 1 0 4h-.09c-.66 0-1.27.4-1.51 1-.26.7-.98 1.2-1.77 1.2h-.09c-.66 0-1.27-.4-1.51-1z" stroke="#0ea5e9" stroke-width="0"/></svg>
        <span>Configurações</span>
      </a>
    </nav>
    <div class="px-6 py-4 border-t text-xs text-gray-400">
      &copy; 2025 Lava-Cash
    </div>
  </aside>
  <main class="flex-1 p-6 main-content">
    <form class="bg-white rounded-xl shadow p-6 mb-8 grid grid-cols-1 md:grid-cols-7 gap-4 items-end">
      <div class="md:col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Ano</label>
        <select id="ano-despesa" class="w-full rounded border px-3 py-2">
          <option>2020</option><option>2021</option><option>2022</option><option>2023</option><option>2024</option>
          <option selected>2025</option><option>2026</option><option>2027</option><option>2028</option><option>2029</option><option>2030</option>
        </select>
      </div>
      <div id="mes-despesa-div" class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-1">Mês</label>
        <select id="mes-despesa" class="w-full rounded border px-3 py-2">
          <option>Janeiro</option><option>Fevereiro</option><option>Março</option><option>Abril</option><option>Maio</option><option>Junho</option>
          <option>Julho</option><option>Agosto</option><option>Setembro</option><option>Outubro</option><option>Novembro</option><option>Dezembro</option>
        </select>
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
        <select class="w-full rounded border px-3 py-2" id="tipo-despesa">
          <option>Fixo</option>
          <option selected>Variável</option>
        </select>
      </div>
      
      <div class="md:col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
        <select id="categoria-despesa" class="w-full rounded border px-3 py-2"></select>
        <script>
        function carregarCategoriasForm() {
          const select = document.getElementById('categoria-despesa');
          const categorias = JSON.parse(localStorage.getItem('categorias')) || [
            'Conta de Água','Energia','Suprimentos','Aluguel','Royalties','Seguro','Contadora','DAS-Impostos','Empréstimo','Salário','INSS'
          ];
          select.innerHTML = '';
          categorias.forEach(cat => {
            const opt = document.createElement('option');
            opt.textContent = cat;
            select.appendChild(opt);
          });
        }
        carregarCategoriasForm();
        window.addEventListener('storage', carregarCategoriasForm);
        </script>
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
        <input type="text" class="w-full rounded border px-3 py-2" placeholder="Ex: Conta de água mês 10" />
      </div>
      <div class="md:col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
        <input id="valor-despesa" name="valor-despesa" type="number" class="w-full rounded border px-3 py-2" placeholder="0,00" min="0" step="0.01" />
      </div>
      <div class="md:col-span-1">
        <button type="submit" class="bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded px-6 py-2 w-full">Adicionar</button>
      </div>
    </form>
    <!-- Filtro de mês -->
    <div class="mb-4">
      <label for="filtro-mes" class="text-sm font-semibold mr-2">Filtrar por mês:</label>
      <select id="filtro-mes" class="border rounded px-2 py-1">
        <option>Janeiro</option><option>Fevereiro</option><option>Março</option><option>Abril</option><option>Maio</option><option>Junho</option>
        <option>Julho</option><option>Agosto</option><option>Setembro</option><option>Outubro</option><option>Novembro</option><option>Dezembro</option>
      </select>
      <label for="filtro-ano" class="text-sm font-semibold ml-4 mr-2">Ano:</label>
      <select id="filtro-ano" class="border rounded px-2 py-1"></select>
    </div>
    <!-- Tabela -->
    <div class="bg-white rounded-xl shadow p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-700 mb-4">Tabela de Despesas</h2>
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-2 py-2 text-left">Ano</th>
            <th class="px-2 py-2 text-left">Mês</th>
            <th class="px-2 py-2 text-left">Tipo</th>
            <th class="px-2 py-2 text-left">Categoria</th>
            <th class="px-2 py-2 text-left">Descrição</th>
            <th class="px-2 py-2 text-right">Valor (R$)</th>
            <th class="px-2 py-2 text-left">Ações</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <tr>
            <td class="px-2 py-2">-</td>
            <td class="px-2 py-2">-</td>
            <td class="px-2 py-2">-</td>
            <td class="px-2 py-2">-</td>
            <td class="px-2 py-2">Nenhuma despesa cadastrada</td>
            <td class="px-2 py-2 text-right">R$ 0,00</td>
            <td class="px-2 py-2"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <script src="js/despesas-utils.js"></script>
  <script>
let despesas = [];
try {
  despesas = JSON.parse(localStorage.getItem('despesas')) || [];
} catch (e) {
  console.warn('Falha ao ler despesas do localStorage:', e);
  despesas = [];
}

// Normaliza despesas existentes: garante que cada item tenha um id
despesas = despesas.map(d => {
  if (!d.id) d.id = genId();
  return d;
});
// persiste IDs adicionados, se houver
saveDespesas();

// utilitário simples de asserção para testes
function _assert(condition, msg) {
  if (!condition) throw new Error('ASSERT: ' + msg);
}

function saveDespesas() {
  try {
    localStorage.setItem('despesas', JSON.stringify(despesas));
    try { localStorage.setItem('despesas_last_update', String(Date.now())); } catch(e) { }
  } catch (e) {
    console.error('[Despesas] erro ao salvar despesas no localStorage:', e);
  }
}

function bloquearTodosEdits() {
  // converte qualquer input aberto de volta para span formatado
  document.querySelectorAll('.valor-edit').forEach(i => {
    const v = parseFloat(i.value);
    const span = document.createElement('span');
    span.className = 'valor-text';
    span.dataset.id = i.dataset.id;
    span.textContent = isNaN(v) ? i.value : `R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
    i.replaceWith(span);
  });
  document.querySelectorAll('.btn-ok').forEach(b => b.classList.add('hidden'));
}

function atualizarTabela() {
  const mesesOrdem = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  const mesSelecionado = document.getElementById('filtro-mes').value;
  const anoSelecionado = (document.getElementById('filtro-ano') && document.getElementById('filtro-ano').value) || new Date().getFullYear().toString();
  const tbody = document.querySelector('.bg-white table tbody');
  tbody.innerHTML = '';
  const filtradas = despesas.filter(d => String(d.mes) === String(mesSelecionado) && String(d.ano) === String(anoSelecionado));
  if (filtradas.length === 0) {
    tbody.innerHTML = `<tr><td class='px-2 py-2' colspan='7'>Nenhuma despesa cadastrada</td></tr>`;
    atualizarDashboard();
    // Ajusta/atualiza o footer de total para 0
    const table = document.querySelector('.bg-white table');
    const oldTfoot = table.querySelector('tfoot');
    if (oldTfoot) oldTfoot.remove();
    const tfoot0 = document.createElement('tfoot');
    tfoot0.innerHTML = `
      <tr class='bg-gray-50 font-semibold'>
        <td class='px-2 py-2'></td>
        <td class='px-2 py-2'></td>
        <td class='px-2 py-2'></td>
        <td class='px-2 py-2'></td>
        <td class='px-2 py-2'></td>
        <td class='px-2 py-2 text-right'>R$ 0,00</td>
        <td class='px-2 py-2'></td>
      </tr>`;
    table.appendChild(tfoot0);
    return;
  }
  // Ordena por mês (dezembro para janeiro)
  const ordenadas = [...filtradas].sort((a, b) => mesesOrdem.indexOf(b.mes) - mesesOrdem.indexOf(a.mes));
  ordenadas.forEach((d) => {
    const tr = document.createElement('tr');
    // id do item
    const itemId = d.id;

    // Valor + botões (somente FIXO editável via botão)
    let valorCell = '';
    let acoesCell = `
      <button onclick="excluirDespesa('${d.id}')" title='Excluir' class='text-gray-600 hover:text-red-600' style='background:none;border:none;'>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 7v12a2 2 0 002 2h8a2 2 0 002-2V7M6 7V5a2 2 0 012-2h8a2 2 0 012 2v2M6 7h12" /></svg>
      </button>
    `;

    if (d.tipo === 'Fixo') {
      const formatted = `R$ ${Number(d.valor).toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
      valorCell = `
        <div class="flex items-center justify-end gap-2">
          <span class="valor-text" data-id="${d.id}">${formatted}</span>
        </div>
      `;
      acoesCell = `
        <div class="flex items-center gap-2">
          <button type="button" class="btn-editar text-gray-600 hover:text-sky-600" title="Editar" style="background:none;border:none;">
            <!-- ícone lápis -->
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M4 20h4l10.607-10.607a1.5 1.5 0 0 0 0-2.121l-1.879-1.879a1.5 1.5 0 0 0-2.121 0L4 16v4z"/></svg>
          </button>
          <button type="button" class="btn-ok hidden text-green-600 hover:text-green-700 font-semibold" title="OK" style="background:none;border:none;">
            <!-- ícone check -->
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          </button>
          <button onclick="excluirDespesa('${d.id}')" title='Excluir' class='text-gray-600 hover:text-red-600' style='background:none;border:none;'>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 7v12a2 2 0 002 2h8a2 2 0 002-2V7M6 7V5a2 2 0 012-2h8a2 2 0 012 2v2M6 7h12" /></svg>
          </button>
        </div>
      `;
    } else {
      valorCell = `R$ ${Number(d.valor).toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
    }

    tr.innerHTML = `
      <td class='px-2 py-2'>${d.ano}</td>
      <td class='px-2 py-2'>${d.mes}</td>
      <td class='px-2 py-2'>${d.tipo}</td>
      <td class='px-2 py-2'>${d.categoria}</td>
      <td class='px-2 py-2'>${d.descricao}</td>
      <td class='px-2 py-2 text-right'>${valorCell}</td>
      <td class='px-2 py-2 text-left'>${acoesCell}</td>
    `;
    tbody.appendChild(tr);

  // --- listeners por-linha ---
    const btnEdit = tr.querySelector('.btn-editar');
    const btnOk = tr.querySelector('.btn-ok');
    const deleteBtn = tr.querySelector('button[onclick^="excluirDespesa"]');

    if (btnEdit) {
      btnEdit.setAttribute('aria-label', 'Editar valor');
      btnEdit.tabIndex = 0;
      btnEdit.addEventListener('click', (ev) => {
        ev.preventDefault();
        bloquearTodosEdits();
        const span = tr.querySelector('.valor-text');
        if (span) {
          const id = span.dataset.id;
          const raw = span.textContent;
          const input = criarInputValorElement(id, raw);
          span.replaceWith(input);
          input.classList.add('ring-2', 'ring-sky-300');
          input.focus();
          input.select && input.select();
        }
        if (btnOk) btnOk.classList.remove('hidden');
        btnEdit.classList.add('editing');
      });
    }

    if (btnOk) {
      btnOk.setAttribute('aria-label', 'Confirmar edição');
      btnOk.tabIndex = 0;
      btnOk.addEventListener('click', (ev) => {
        ev.preventDefault();
        const input = tr.querySelector('.valor-edit');
        if (input) {
          const id = input.dataset.id;
          const idx = despesas.findIndex(x => x.id === id);
          const novo = parseFloat(input.value);
          if (!isNaN(novo) && idx >= 0) {
            despesas[idx].valor = novo;
            saveDespesas();
            mostrarMensagem('Valor atualizado com sucesso.');
          }
          const span = criarSpanValorElement(input.dataset.id, novo);
          input.replaceWith(span);
        }
        btnOk.classList.add('hidden');
        btnEdit.classList.remove('editing');
      });

      // Enter confirma dentro da linha
      tr.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.target && e.target.classList && e.target.classList.contains('valor-edit')) {
          e.preventDefault();
          btnOk.click();
        }
      });
    }

    if (deleteBtn) {
      deleteBtn.setAttribute('aria-label', 'Excluir despesa');
      deleteBtn.tabIndex = 0;
    }
  });

  // adiciona rodapé com total do mês selecionado — exatamente abaixo da coluna Valor (6ª coluna)
  const totalMes = ordenadas.reduce((acc, it) => acc + (Number(it.valor) || 0), 0);
  const table = document.querySelector('.bg-white table');
  // remove footer antigo se existir
  const oldTfoot = table.querySelector('tfoot');
  if (oldTfoot) oldTfoot.remove();
  const tfoot = document.createElement('tfoot');
  tfoot.innerHTML = `
    <tr class='bg-gray-50 font-semibold'>
      <td class='px-2 py-2'></td>
      <td class='px-2 py-2'></td>
      <td class='px-2 py-2'></td>
      <td class='px-2 py-2'></td>
      <td class='px-2 py-2'></td>
      <td class='px-2 py-2 text-right'>
        R$ ${totalMes.toLocaleString('pt-BR',{minimumFractionDigits:2})}
      </td>
      <td class='px-2 py-2'></td>
    </tr>`;
  table.appendChild(tfoot);

  atualizarDashboard();
  saveDespesas();
}

function excluirDespesa(id) {
  const idx = despesas.findIndex(x => x.id === id);
  if (idx === -1) return;
  despesas.splice(idx, 1);
  atualizarTabela();
  saveDespesas();
}

function atualizarDashboard() {
  const hoje = new Date();
  const mesAtual = hoje.toLocaleString('pt-BR', {month: 'long'});
  const anoAtual = hoje.getFullYear().toString();
  const total = despesas.reduce((acc, d) => {
    if (d.mes === mesAtual && d.ano === anoAtual) {
      return acc + Number(d.valor);
    }
    return acc;
  }, 0);
  const alvo = document.querySelector('.text-2xl.font-bold.text-red-500');
  if (alvo) alvo.textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
}

document.getElementById('tipo-despesa').addEventListener('change', function() {
  const mesDespesaDiv = document.getElementById('mes-despesa-div');
  if (this.value === 'Fixo') {
    mesDespesaDiv.style.display = 'none';
  } else {
    mesDespesaDiv.style.display = '';
  }
});

document.querySelector('form').addEventListener('submit', function(e) {
  e.preventDefault();
  const ano = document.getElementById('ano-despesa').value;
  const tipo = document.getElementById('tipo-despesa').value;
  const categoria = document.getElementById('categoria-despesa').value;
  const descricao = this.querySelector('input[type="text"]').value;
  // lê o valor específico do input do valor (evita confundir com o input de frequência)
  const valorRaw = (document.getElementById('valor-despesa') || this.querySelector('input[type="number"]')).value;
  const valor = parseFloat(String(valorRaw).replace(',', '.'));
  if (!valor) {
    mostrarMensagem('Preencha o valor!', true);
    return;
  }
  if (tipo === 'Fixo') {
    const meses = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    meses.forEach(mes => {
      despesas.push({id: genId(), ano, mes, tipo, categoria, descricao: descricao || categoria, valor});
    });
  } else {
    const mes = document.getElementById('mes-despesa').value;
    despesas.push({id: genId(), ano, mes, tipo, categoria, descricao: descricao || categoria, valor});
  }
  atualizarTabela();
  saveDespesas();
  mostrarMensagem('Dados cadastrados com sucesso!');
  this.reset();
  // após reset, restaura os defaults para ano/mês atuais
  const now = new Date();
  const anoAtual = now.getFullYear().toString();
  const mesAtual = now.toLocaleString('pt-BR', {month: 'long'});
  const mesAtualCap = mesAtual.charAt(0).toUpperCase() + mesAtual.slice(1);
  const anoElem = document.getElementById('ano-despesa');
  const mesElem = document.getElementById('mes-despesa');
  if (anoElem) anoElem.value = anoAtual;
  if (mesElem) mesElem.value = mesAtualCap;
  this.querySelector('select').dispatchEvent(new Event('change'));
});

function mostrarMensagem(msg, erro = false) {
  let div = document.getElementById('mensagem-sucesso');
  if (!div) {
    div = document.createElement('div');
    div.id = 'mensagem-sucesso';
    div.className = 'mb-4 p-3 rounded font-semibold';
    document.querySelector('main').insertBefore(div, document.querySelector('form'));
  }
  div.textContent = msg;
  div.className = erro ? 'mb-4 p-3 rounded bg-red-100 text-red-700 font-semibold' : 'mb-4 p-3 rounded bg-green-100 text-green-700 font-semibold';
  div.classList.remove('hidden');
  setTimeout(() => div.classList.add('hidden'), 2500);
}

document.getElementById('filtro-mes').addEventListener('change', atualizarTabela);
// Define o mês atual como padrão ao carregar
window.addEventListener('DOMContentLoaded', function() {
  const filtroMes = document.getElementById('filtro-mes');
  const anoDespesa = document.getElementById('ano-despesa');
  const mesDespesa = document.getElementById('mes-despesa');
  const now = new Date();
  const anoAtual = now.getFullYear().toString();
  const mesAtual = now.toLocaleString('pt-BR', {month: 'long'});
  const mesAtualCap = mesAtual.charAt(0).toUpperCase() + mesAtual.slice(1);

  // define defaults do formulário e do filtro para o mês/ano atual
  if (anoDespesa) anoDespesa.value = anoAtual;
  if (mesDespesa) mesDespesa.value = mesAtualCap;
  if (filtroMes) filtroMes.value = mesAtualCap;
  
  // popula filtro de ano com anos presentes nas despesas (ou ano atual se vazio)
  const filtroAno = document.getElementById('filtro-ano');
  if (filtroAno) {
    const anos = [...new Set(despesas.map(d => String(d.ano)).filter(Boolean))].sort((a,b)=>Number(b)-Number(a));
    filtroAno.innerHTML = '';
    if (anos.length === 0) {
      const opt = document.createElement('option'); opt.value = anoAtual; opt.textContent = anoAtual; filtroAno.appendChild(opt);
    } else {
      anos.forEach(a => { const opt = document.createElement('option'); opt.value = a; opt.textContent = a; filtroAno.appendChild(opt); });
      if (anos.includes(anoAtual)) filtroAno.value = anoAtual;
    }
    // se o filtroAno for alterado, atualiza a tabela
    filtroAno.addEventListener('change', atualizarTabela);
  }

  atualizarTabela();
});

// garante salvar ao sair da página
window.addEventListener('beforeunload', function () { saveDespesas(); });

// inicializa tabela
atualizarTabela();

// Se outro contexto (outra aba/janela) alterar 'despesas' no localStorage
// o evento 'storage' será recebido aqui — recarrega e re-renderiza.
window.addEventListener('storage', (e) => {
  if (e.key === 'despesas' || e.key === 'despesas_last_update') {
    try {
      despesas = JSON.parse(localStorage.getItem('despesas')) || [];
    } catch (err) {
      console.warn('Falha ao ler despesas via storage event:', err);
      despesas = [];
    }
    // garante ids e persiste caso necessário
    despesas = despesas.map(d => { if (!d.id) d.id = genId(); return d; });
    saveDespesas();
    atualizarTabela();
    atualizarDashboard();
  }
});
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lava-Cash | Importar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/app.css">
  <!-- estilos compartilhados movidos para css/app.css -->
</head>
<body class="bg-gray-50 min-h-screen flex">
  <aside class="w-48 lg:w-64 bg-white shadow-lg flex flex-col">
    <div class="flex items-center gap-2 px-6 py-6 border-b">
      <!-- Logo SVG -->
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
        <ellipse cx="16" cy="16" rx="14" ry="14" fill="#38bdf8"/>
        <path d="M16 6C19 12 26 13 16 26C6 13 13 12 16 6Z" fill="#0ea5e9"/>
      </svg>
      <span class="text-xl font-bold text-sky-600">Lava-Cash</span>
    </div>
    <nav class="flex-1 px-4 py-6 space-y-2">
      <a href="index.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h8V3H3v10zM3 21h8v-6H3v6zM13 21h8V11h-8v10zM13 3v6h8V3h-8z" fill="#0ea5e9"/></svg>
        <span>Dashboard</span>
      </a>
      <a href="importar.html" class="sidebar-link active" aria-current="page">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v9" stroke="#0ea5e9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="#0ea5e9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Importar</span>
      </a>
      <a href="receitas.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v2M5 7h14M4 21h16v-8H4v8z" stroke="#10b981" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Receitas</span>
      </a>
      <a href="despesas.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Despesas</span>
      </a>
      <a href="ajuda.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 18h.01M12 14a4 4 0 1 0-4-4" stroke="#64748b" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Ajuda</span>
      </a>
      <a href="configuracoes.html" class="sidebar-link">
        <svg class="sidebar-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="#0ea5e9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 4.28 18.9l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c.66 0 1.27-.4 1.51-1a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.1 4.28l.06.06a1.65 1.65 0 0 0 1.82.33h.09C9.3 4.4 9.9 4 10.56 4H13.44c.66 0 1.27.4 1.51 1 .26.7.98 1.2 1.77 1.2h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 1 1 19.72 5.1l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09c0 .66.4 1.27 1 1.51H21a2 2 0 1 1 0 4h-.09c-.66 0-1.27.4-1.51 1-.26.7-.98 1.2-1.77 1.2h-.09c-.66 0-1.27-.4-1.51-1z" stroke="#0ea5e9" stroke-width="0"/></svg>
        <span>Configurações</span>
      </a>
    </nav>
    <div class="px-6 py-4 border-t text-xs text-gray-400">
      &copy; 2025 Lava-Cash
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Importar Dados</h1>
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
      <!-- Coluna única para ambos os uploads (empilhados) -->
      <div class="col-span-1 lg:col-span-1 flex flex-col gap-4">
        <!-- Upload Vendas Cartões (existente) -->
        <div class="bg-white rounded-lg shadow p-4 flex flex-col">
          <h2 class="text-md font-semibold text-gray-700 mb-2">Importar Vendas em Cartões</h2>
          <span class="text-gray-500 text-sm mb-1">Selecione um arquivo CSV ou Excel</span>
          <input type="file" id="fileInputCartao" accept=".csv,.xlsx" class="mt-1 text-sm" multiple />
          <p id="fileNameCartao" class="mt-1 text-sm text-gray-600"></p>
          <button id="processarBtnCartao" data-loading="false" class="btn-primary btn-loading bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded px-4 py-1.5 mt-3 text-sm" disabled>Processar</button>
        </div>

        <!-- Upload Vendas PIX (novo) -->
        <div class="bg-white rounded-lg shadow p-4 flex flex-col">
          <h2 class="text-md font-semibold text-gray-700 mb-2">Importar Vendas via PIX</h2>
          <span class="text-gray-500 text-sm mb-1">Selecione um arquivo CSV ou Excel (PIX)</span>
          <input type="file" id="fileInputPix" accept=".csv,.xlsx" class="mt-1 text-sm" multiple />
          <p id="fileNamePix" class="mt-1 text-sm text-gray-600"></p>
          <button id="processarBtnPix" data-loading="false" class="btn-primary btn-loading bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded px-4 py-1.5 mt-3 text-sm" disabled>Processar</button>
        </div>
      </div>

      <!-- Preview e Resumo (agora ocupa 3 colunas em telas grandes) -->
      <div class="col-span-1 lg:col-span-3 bg-white rounded-xl shadow p-6 flex flex-col preview-box">
        <h2 class="text-lg font-semibold text-gray-700 mb-3">Preview</h2>
        <div id="preview" class="text-sm text-gray-600">Nenhum arquivo selecionado.</div>
        <div id="tabelaPreview" class="mt-4 overflow-x-auto"></div>
        <div id="tabelaResumo" class="mt-6 overflow-x-auto resumo-table"></div>
        <div class="mt-4 flex gap-2">
          <button id="excluirSelecionadosBtn" class="bg-red-500 hover:bg-red-600 text-white rounded px-4 py-2" disabled>Excluir Selecionados</button>
          <button id="limparResumoBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 rounded px-4 py-2">Limpar Tudo</button>
        </div>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <a href="despesas.html" class="bg-red-500 hover:bg-red-600 text-white rounded-xl p-6 flex items-center gap-4 transition">
        <svg width="32" height="32" fill="none"><path d="M8 16h16M16 8v16" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="text-lg font-semibold">Adicionar Despesa</span>
      </a>
      <!-- Card de Gráficos removido porque a página não existe mais -->
    </div>
  </main>

  <script>
    // Elementos para cartões
    const fileInputCartao = document.getElementById('fileInputCartao');
    const fileNameCartao = document.getElementById('fileNameCartao');
    const processarBtnCartao = document.getElementById('processarBtnCartao');

    // Elementos para PIX
    const fileInputPix = document.getElementById('fileInputPix');
    const fileNamePix = document.getElementById('fileNamePix');
    const processarBtnPix = document.getElementById('processarBtnPix');

    const preview = document.getElementById('preview');
    const tabelaPreview = document.getElementById('tabelaPreview');
    const tabelaResumo = document.getElementById('tabelaResumo');
    const excluirSelecionadosBtn = document.getElementById('excluirSelecionadosBtn');
    const limparResumoBtn = document.getElementById('limparResumoBtn');

  let arquivosSelecionadosCartao = [];
  let arquivosSelecionadosPix = [];

    // Util: parsear número com separador decimal ponto ou vírgula
    function parseNumber(v) {
      if (v === undefined || v === null) return 0;
      const s = String(v).replace(/R\$|\s/g, '').replace(',', '.');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function excelDateToJSDate(serial) {
      const utc = new Date((serial - 25569) * 86400 * 1000);
      utc.setHours(utc.getHours() + 3);
      return utc;
    }

    // Estado local para paginação / filtros por coluna (listas selecionadas)
    const resumoState = {
      page: 1,
      pageSize: 6,
      // arrays com os valores selecionados; array vazio = todos
      columnFilters: { anoMes: [], source: [], tipoPagamento: [] }
    };

    // Renderiza tabela resumo com checkboxes, acessibilidade, pesquisa, paginação e tooltips
    function atualizarResumo() {
      const vendasSalvas = JSON.parse(localStorage.getItem('vendasResumo')) || [];
      // mantém os dados na state
      const dados = vendasSalvas.slice().sort((a,b)=> (a.anoMes||'').localeCompare(b.anoMes||''));

      // Filtra pelos filtros por coluna (listas de seleção estilo Excel)
      const cf = resumoState.columnFilters || { anoMes: [], source: [], tipoPagamento: [] };
      // helper para normalizar
      const normalizeText = (s) => String(s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,'');
      const filtrados = dados.filter(d => {
        // Ano/Mês
        if (Array.isArray(cf.anoMes) && cf.anoMes.length > 0) {
          if (!cf.anoMes.map(normalizeText).includes(normalizeText(d.anoMes || ''))) return false;
        }
        // Fonte (compara contra rótulo exibido)
        const fonteLabel = (d.source === 'cartao' ? 'Cartoes' : d.source === 'pix' ? 'PIX' : String(d.source || ''));
        if (Array.isArray(cf.source) && cf.source.length > 0) {
          if (!cf.source.map(normalizeText).includes(normalizeText(fonteLabel))) return false;
        }
        // Tipo de Pagamento
        if (Array.isArray(cf.tipoPagamento) && cf.tipoPagamento.length > 0) {
          if (!cf.tipoPagamento.map(normalizeText).includes(normalizeText(d.tipoPagamento || ''))) return false;
        }
        return true;
      });

      if (filtrados.length === 0) {
        tabelaResumo.innerHTML = `
          <div class="px-3 py-4">
            <div class="flex items-center justify-between gap-4">
              <div class="flex items-center gap-2">
                <input id="resumoSearch" aria-label="Pesquisar resumo" placeholder="Pesquisar por Ano/Mês ou Fonte" class="px-3 py-2 border rounded w-64 text-sm" />
                <label for="resumoPageSize" class="sr-only">Itens por página</label>
                <select id="resumoPageSize" class="px-2 py-1 border rounded text-sm" aria-label="Itens por página">
                  <option value="6">6</option>
                  <option value="12">12</option>
                  <option value="24">24</option>
                </select>
              </div>
              <div class="text-sm text-gray-500">Nenhum resumo disponível.</div>
            </div>
          </div>
        `;
        // attach search handler
        const inputVazio = document.getElementById('resumoSearch');
        const pageSelectVazio = document.getElementById('resumoPageSize');
        if (inputVazio) inputVazio.addEventListener('input', (e)=>{resumoState.filter = e.target.value; resumoState.page = 1; atualizarResumo();});
        if (pageSelectVazio) pageSelectVazio.addEventListener('change', (e)=>{resumoState.pageSize = Number(e.target.value); resumoState.page = 1; atualizarResumo();});
        excluirSelecionadosBtn.disabled = true;
        return;
      }

      // Paginação
      const totalItems = filtrados.length;
      const totalPages = Math.max(1, Math.ceil(totalItems / resumoState.pageSize));
      if (resumoState.page > totalPages) resumoState.page = totalPages;
      const start = (resumoState.page - 1) * resumoState.pageSize;
      const end = start + resumoState.pageSize;
      const pageItems = filtrados.slice(start, end);

      // Totais baseados no conjunto filtrado (não apenas na página)
      const totais = filtrados.reduce((acc, v) => {
        acc.receitaBruta += Number(v.receitaBruta || 0);
        acc.mdr += Number(v.mdr || 0);
        acc.receitaLiquida += Number(v.receitaLiquida || 0);
        return acc;
      }, {receitaBruta:0, mdr:0, receitaLiquida:0});

      // Conteúdo: pesquisa + tabela
      let html = `
        <div class="px-3 py-3">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div class="flex items-center gap-2">
              <label for="resumoPageSize" class="text-sm text-gray-600">Itens / página</label>
              <select id="resumoPageSize" class="px-2 py-1 border rounded text-sm" aria-label="Itens por página">
                <option value="6" ${resumoState.pageSize===6? 'selected':''}>6</option>
                <option value="12" ${resumoState.pageSize===12? 'selected':''}>12</option>
                <option value="24" ${resumoState.pageSize===24? 'selected':''}>24</option>
              </select>
              <div class="text-sm text-gray-500 ml-3">${totalItems} item(s)</div>
            </div>
            <div class="text-sm text-gray-500">Mostrando ${start+1}–${Math.min(end,totalItems)} de ${totalItems}</div>
          </div>
        </div>
        <div id="resumoTableWrapper" class="overflow-x-auto border rounded-lg bg-white transition-shadow duration-200">
          <table class="min-w-full text-xs table-auto">
            <thead id="resumoThead" class="bg-gray-50 border-b sticky top-0">
              <tr class="text-left text-xs text-gray-600">
                <th class="px-2 py-2"><input id="selectAll" aria-label="Selecionar todos os resumos" type="checkbox" class="h-4 w-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500" /></th>
                <th class="px-2 py-2">Ano / Mês</th>
                <th class="px-2 py-2 text-right">Receita Bruta</th>
                <th class="px-2 py-2 text-right">MDR</th>
                <th class="px-2 py-2 text-right">Receita Líquida</th>
                <th class="px-2 py-2">Fonte</th>
                <th class="px-2 py-2">Tipo de Pagamento</th>
              </tr>
              <tr class="bg-gray-100">
                <th class="px-2 py-2"></th>
                <th class="px-2 py-2"><div data-filter-container="anoMes"></div></th>
                <th class="px-2 py-2"></th>
                <th class="px-2 py-2"></th>
                <th class="px-2 py-2"></th>
                <th class="px-2 py-2"><div data-filter-container="source"></div></th>
                <th class="px-2 py-2"><div data-filter-container="tipoPagamento"></div></th>
              </tr>
            </thead>
            <tbody class="divide-y">
      `;

      pageItems.forEach((v, idx) => {
  const globalIdx = start + idx;
  const bgClass = globalIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
  const receitaBruta = Number(v.receitaBruta || 0).toLocaleString('pt-BR', {minimumFractionDigits:2});
  const mdrVal = Number(v.mdr || 0);
  const mdr = mdrVal.toLocaleString('pt-BR', {minimumFractionDigits:2});
  const receitaLiquida = Number(v.receitaLiquida || 0).toLocaleString('pt-BR', {minimumFractionDigits:2});
  const source = (v.source || 'desconhecida').toLowerCase();
  const badge = source === 'cartao' ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-800">Cartões</span>' :
          source === 'pix' ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800">PIX</span>' :
          `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700">${escapeHtml(v.source)}</span>`;
  const tipoPagamento = escapeHtml(v.tipoPagamento || '');

        // tooltip de MDR com percent
        const percentualMdr = (Number(v.receitaBruta || 0) === 0) ? 0 : ((mdrVal / Number(v.receitaBruta || 0)) * 100);
        const tooltip = `MDR: R$ ${mdr} (${percentualMdr.toFixed(2)}%)`;

        html += `
          <tr class="${bgClass} hover:bg-sky-50 transition" data-idx-row="${globalIdx}">
            <td class="px-2 py-2"><input data-idx='${globalIdx}' aria-label="Selecionar linha ${escapeHtml(v.anoMes || '')}" class='rowCheckbox h-4 w-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500' type='checkbox' /></td>
            <td class="px-2 py-2 font-medium">${escapeHtml(v.anoMes)}</td>
            <td class="px-2 py-2 text-right">R$ ${receitaBruta}</td>
            <td class="px-2 py-2 text-right" title="${escapeHtml(tooltip)}">R$ ${mdr} <span class="sr-only"> - ${escapeHtml(tooltip)}</span> <span class="ml-2 text-gray-400" aria-hidden="true">ℹ️</span></td>
            <td class="px-2 py-2 text-right text-sky-700 font-semibold">R$ ${receitaLiquida}</td>
            <td class="px-2 py-2">${badge}</td>
            <td class="px-2 py-2">${tipoPagamento}</td>
          </tr>
        `;
      });

      // Rodapé com totais
      html += `
            </tbody>
            <tfoot class="bg-gray-50">
              <tr class="text-sm font-semibold text-gray-700">
                <td class="px-2 py-2">&nbsp;</td>
                <td class="px-2 py-2">Totais</td>
                <td class="px-2 py-2 text-right">R$ ${Number(totais.receitaBruta).toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                <td class="px-2 py-2 text-right">R$ ${Number(totais.mdr).toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                <td class="px-2 py-2 text-right text-sky-700">R$ ${Number(totais.receitaLiquida).toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                <td class="px-2 py-2">&nbsp;</td>
                <td class="px-2 py-2">&nbsp;</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="mt-3 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <button id="prevPage" class="px-3 py-1 border rounded text-sm" ${resumoState.page===1? 'disabled':''} aria-label="Página anterior">Anterior</button>
            <button id="nextPage" class="px-3 py-1 border rounded text-sm" ${resumoState.page===totalPages? 'disabled':''} aria-label="Próxima página">Próxima</button>
            <div class="text-sm text-gray-500">Página ${resumoState.page} de ${totalPages}</div>
          </div>
          <div class="text-sm text-gray-500">Use a pesquisa para filtrar resultados.</div>
        </div>
      `;

      tabelaResumo.innerHTML = html;

      // Hook: pageSize
      const pageSelect = document.getElementById('resumoPageSize');
      if (pageSelect) pageSelect.addEventListener('change', (e)=>{resumoState.pageSize = Number(e.target.value); resumoState.page = 1; atualizarResumo();});

      // Renderizar filtros estilo Excel (listas com checkboxes)
      (function renderColumnFilters(allDados){
        const keys = ['anoMes','source','tipoPagamento'];
        keys.forEach(key => {
          const container = document.querySelector(`[data-filter-container="${key}"]`);
          if (!container) return;
          // computa valores únicos a partir de allDados
          let values = Array.from(new Set(allDados.map(d => {
            if (key === 'source') return (d.source === 'cartao' ? 'Cartões' : d.source === 'pix' ? 'PIX' : (d.source || ''));
            return d[key] || '';
          }).filter(v=>v !== undefined && v !== null)));
          values = values.map(v => String(v));
          values.sort((a,b)=> a.localeCompare(b));

          // construir dropdown UI
          const panelId = `filter-panel-${key}`;
          let htmlPanel = `<div class="relative inline-block text-left w-full">
            <div>
              <button type="button" data-key="${key}" class="px-2 py-1 border rounded text-sm w-full filter-toggle">Filtrar ▾</button>
            </div>
            <div id="${panelId}" class="filter-panel hidden absolute left-0 mt-1 w-56 max-h-60 overflow-auto bg-white border rounded shadow z-50 p-2">
              <div class="mb-2"><label><input type=checkbox data-key="${key}" data-val="__ALL__" class="filter-opt-all" checked /> Selecionar todos</label></div>`;
          values.forEach(v => {
            const safe = escapeHtml(String(v));
            htmlPanel += `<div class="text-sm"><label><input type=checkbox data-key="${key}" data-val="${safe}" class="filter-option" checked /> ${safe}</label></div>`;
          });
          htmlPanel += `</div></div>`;
          container.innerHTML = htmlPanel;

          // listeners: toggle
          const toggleBtn = container.querySelector('.filter-toggle');
          const panel = container.querySelector('.filter-panel');
          toggleBtn && toggleBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); panel.classList.toggle('hidden'); });

          // fechar ao clicar fora
          document.addEventListener('click', (ev)=>{ if (!container.contains(ev.target)) panel.classList.add('hidden'); });

          // option listeners
          const optAll = container.querySelector('.filter-opt-all');
          const opts = Array.from(container.querySelectorAll('.filter-option'));
          const setAllChecked = (checked) => { opts.forEach(o=>{ o.checked = checked; }); };
          optAll && optAll.addEventListener('change', (e)=>{ setAllChecked(e.target.checked);
            // update state
            resumoState.columnFilters[key] = e.target.checked ? [] : opts.map(o=>o.dataset.val);
            resumoState.page = 1; atualizarResumo();
          });
          opts.forEach(o => o.addEventListener('change', ()=>{
            // if any unchecked, uncheck optAll
            if (opts.some(x=>!x.checked)) { if (optAll) optAll.checked = false; }
            else { if (optAll) optAll.checked = true; }
            const selected = opts.filter(x=>x.checked).map(x=> x.dataset.val);
            resumoState.columnFilters[key] = selected;
            resumoState.page = 1; atualizarResumo();
          }));

          // inicializa estado: se colunaFilters tiver valores, aplicar seleção
          if (Array.isArray(resumoState.columnFilters[key]) && resumoState.columnFilters[key].length>0) {
            const wanted = resumoState.columnFilters[key].map(v=>String(v));
            opts.forEach(o => { o.checked = wanted.includes(o.dataset.val); });
            if (optAll) optAll.checked = opts.every(x=>x.checked);
          }
        });
      })(dados);

      // Hook para selecionar tudo com ARIA
      const selectAll = document.getElementById('selectAll');
      const rowCheckboxes = Array.from(document.querySelectorAll('.rowCheckbox'));
      excluirSelecionadosBtn.disabled = !rowCheckboxes.some(r=>r.checked);
      selectAll && (selectAll.checked = rowCheckboxes.length > 0 && rowCheckboxes.every(r=>r.checked));
      selectAll && selectAll.addEventListener('change', (e) => {
        rowCheckboxes.forEach(cb => cb.checked = e.target.checked);
        excluirSelecionadosBtn.disabled = !e.target.checked;
        // visual highlight
        rowCheckboxes.forEach(cb => {
          const tr = cb.closest('tr');
          if (tr) tr.classList.toggle('bg-sky-100', cb.checked);
        });
      });
      rowCheckboxes.forEach(cb => cb.addEventListener('change', () => {
        const anyChecked = rowCheckboxes.some(r => r.checked);
        excluirSelecionadosBtn.disabled = !anyChecked;
        const tr = cb.closest('tr');
        if (tr) tr.classList.toggle('bg-sky-100', cb.checked);
        if (selectAll) selectAll.checked = rowCheckboxes.every(r=>r.checked);
      }));

      // Paginação handlers
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      if (prevBtn) prevBtn.addEventListener('click', ()=>{ if (resumoState.page>1) { resumoState.page--; atualizarResumo(); } });
      if (nextBtn) nextBtn.addEventListener('click', ()=>{ if (resumoState.page<totalPages) { resumoState.page++; atualizarResumo(); } });

      // Sticky header shadow ao rolar
      const wrapper = document.getElementById('resumoTableWrapper');
      if (wrapper) {
        const toggleShadow = ()=>{
          if (wrapper.scrollTop > 0) wrapper.classList.add('shadow-lg'); else wrapper.classList.remove('shadow-lg');
        };
        // inicial
        toggleShadow();
        wrapper.addEventListener('scroll', toggleShadow);
      }
    }

    // Pequena utilidade para escapar texto em HTML quando injetamos valores
    function escapeHtml(unsafe) {
      if (unsafe === undefined || unsafe === null) return '';
      return String(unsafe)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Aplica estilo/estrutura da tabela de despesas do ano à tabela de preview
    function enhancePreviewTable(){
      const wrapper = document.getElementById('tabelaPreview');
      if (!wrapper) return;
      const table = wrapper.querySelector('table');
      if (!table) return;
      // classes base semelhantes à tabela de despesas
      table.classList.add('min-w-full','divide-y','divide-gray-200','text-sm');
      // tornar os th consistentes
      table.querySelectorAll('th').forEach(th => th.classList.add('px-2','py-2','text-left'));
      // adicionar selectAll no header se não houver
      const thead = table.querySelector('thead');
      if (thead && !thead.querySelector('#selectAllPreview')){
        const firstRow = thead.querySelector('tr');
        if (firstRow){
          const th = document.createElement('th');
          th.className = 'px-2 py-2';
          th.innerHTML = `<input id="selectAllPreview" type="checkbox" aria-label="Selecionar todos" />`;
          firstRow.insertBefore(th, firstRow.firstChild);
        }
      }
      // adicionar checkbox nas linhas se não houver
      table.querySelectorAll('tbody tr').forEach(tr => {
        if (!tr.querySelector('.rowCheckbox')){
          const td = document.createElement('td');
          td.className = 'px-2 py-2';
          td.innerHTML = `<input type="checkbox" class="rowCheckbox h-4 w-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500" />`;
          tr.insertBefore(td, tr.firstChild);
        }
      });
      // listeners: selectAll and per-row
      const selectAll = table.querySelector('#selectAllPreview');
      const rowCheckboxes = Array.from(table.querySelectorAll('.rowCheckbox'));
      if (selectAll){
        selectAll.checked = rowCheckboxes.length > 0 && rowCheckboxes.every(r=>r.checked);
        selectAll.addEventListener('change', (e)=>{
          rowCheckboxes.forEach(cb => {
            cb.checked = e.target.checked;
            const tr = cb.closest('tr'); if (tr) tr.classList.toggle('bg-sky-100', e.target.checked);
          });
        });
      }
      rowCheckboxes.forEach(cb => cb.addEventListener('change', ()=>{
        if (selectAll) selectAll.checked = rowCheckboxes.length > 0 && rowCheckboxes.every(r=>r.checked);
        const tr = cb.closest('tr'); if (tr) tr.classList.toggle('bg-sky-100', cb.checked);
      }));
    }

    // Excluir selecionados
    excluirSelecionadosBtn.addEventListener('click', () => {
      const vendasSalvas = JSON.parse(localStorage.getItem('vendasResumo')) || [];
      const rowCheckboxes = Array.from(document.querySelectorAll('.rowCheckbox'));
      const idxToRemove = rowCheckboxes.filter(cb => cb.checked).map(cb => Number(cb.dataset.idx));
      if (idxToRemove.length === 0) return;
      // Remove por índice (do maior para o menor)
      idxToRemove.sort((a,b) => b-a).forEach(i => vendasSalvas.splice(i,1));
      localStorage.setItem('vendasResumo', JSON.stringify(vendasSalvas));
      atualizarResumo();
      atualizarDashboardGraficos();
      alert(`Foram removidos ${idxToRemove.length} item(s).`);
    });

    limparResumoBtn.addEventListener('click', () => {
      if (!confirm('Deseja realmente limpar todo o resumo de vendas?')) return;
      localStorage.removeItem('vendasResumo');
      atualizarResumo();
      atualizarDashboardGraficos();
    });

    function atualizarDashboardGraficos() {
      const vendasSalvas = JSON.parse(localStorage.getItem('vendasResumo')) || [];
      const receitaLiquidaTotal = vendasSalvas.reduce((acc, v) => acc + Number(v.receitaLiquida || 0), 0);
      localStorage.setItem('receitaLiquidaTotal', receitaLiquidaTotal);
    }

    // Inicializa eventos de input
    fileInputCartao && fileInputCartao.addEventListener('change', (e) => {
      const files = e.target.files ? Array.from(e.target.files) : [];
      arquivosSelecionadosCartao = files;
      fileNameCartao.textContent = files.length ? `Arquivos: ${files.map(f=>f.name).join(', ')}` : '';
      preview.textContent = files.length ? 'Arquivo(s) pronto(s) para processamento.' : 'Nenhum arquivo selecionado.';
      processarBtnCartao.disabled = files.length === 0;
      processarBtnCartao.dataset.loading = 'false';
      tabelaPreview.innerHTML = '';
    });

    fileInputPix && fileInputPix.addEventListener('change', (e) => {
      const files = e.target.files ? Array.from(e.target.files) : [];
      arquivosSelecionadosPix = files;
      fileNamePix.textContent = files.length ? `Arquivos: ${files.map(f=>f.name).join(', ')}` : '';
      preview.textContent = files.length ? 'Arquivo(s) PIX pronto(s) para processamento.' : 'Nenhum arquivo selecionado.';
      processarBtnPix.disabled = files.length === 0;
      processarBtnPix.dataset.loading = 'false';
      tabelaPreview.innerHTML = '';
    });

    // Processar arquivo de cartões (mantido similar ao original)
    processarBtnCartao && processarBtnCartao.addEventListener('click', async () => {
      if (!arquivosSelecionadosCartao || arquivosSelecionadosCartao.length === 0) return;
      processarBtnCartao.dataset.loading = 'true';
      console.log('[Importar] Iniciando processamento de cartões. Arquivos:', arquivosSelecionadosCartao.map(f=>f.name));
      let resumoPorMes = {}; // chave: `${anoMes}||${tipoPagamento}`
      let totalVendas = 0;
      try {
        for (const arquivo of arquivosSelecionadosCartao) {
          console.log(`[Importar] Lendo arquivo: ${arquivo.name}`);
          const data = await arquivo.arrayBuffer();
          const workbook = XLSX.read(new Uint8Array(data), {type: 'array'});
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, {header:1});
          console.log(`[Importar] Linhas lidas no arquivo ${arquivo.name}:`, json.length);
          if (json.length <= 2) console.warn(`[Importar] O arquivo ${arquivo.name} tem ${json.length} linhas; verifique o cabeçalho e o conteúdo.`);
          // mostra as primeiras linhas para diagnóstico
          console.log('[Importar] Exemplo primeiras linhas:', json.slice(0,6));

          // detectar automaticamente a linha de cabeçalho (procura por 'data da venda' e 'modalidade')
          let headerRowIndex = 0;
          for (let hi = 0; hi < Math.min(10, json.length); hi++) {
            const r = json[hi];
            if (!r) continue;
            const rowStr = (Array.isArray(r) ? r.join(' ').toLowerCase() : String(r).toLowerCase());
            if (rowStr.includes('data da venda') && rowStr.includes('modalidade')) {
              headerRowIndex = hi;
              console.log('[Importar] Cabeçalho detectado na linha', hi, '->', r);
              break;
            }
          }

          for (let i = headerRowIndex + 1; i < json.length; i++) {
            let row = json[i];
            if (!row) continue;
            // caso CSV com ; (toda linha em row[0])
            if (Array.isArray(row) && row.length === 1 && typeof row[0] === 'string' && row[0].includes(';')) {
              row = row[0].split(';').map(c => c === undefined || c === null ? '' : String(c).trim());
            }
            // diagnóstico rápido: se as colunas essenciais estiverem undefined, logue a linha
            const hasEssential = row[0] !== undefined || row[2] !== undefined || row[4] !== undefined;
            if (!hasEssential) { console.warn('[Importar] Linha sem colunas essenciais (p.ex. data/status/valor):', i, row); continue; }

            const dataVenda = row[0]; // A
            const horaVenda = row[1]; // B
            const status = String(row[2] || '').trim().toLowerCase(); // C
            if (status === 'negada') continue;

            // anoMes
            let anoMes = 'Indefinido';
            if (typeof dataVenda === 'string' && dataVenda.includes('/')) {
              const parts = dataVenda.split('/');
              if (parts.length >= 3) {
                const dia = parts[0].padStart(2,'0');
                const mes = parts[1].padStart(2,'0');
                const ano = parts[2].split(' ')[0];
                anoMes = `${ano}/${mes}`;
              }
            } else if (!isNaN(dataVenda)) {
              const d = excelDateToJSDate(Number(dataVenda));
              const mes = String(d.getMonth()+1).padStart(2,'0');
              const ano = d.getFullYear();
              anoMes = `${ano}/${mes}`;
            }

            // modalidade -> coluna F (index 5)
            const modalidadeRaw = (row[5] || '').toString().trim().toLowerCase();
            // normalizar acentos e espaços
            const modalidadeNorm = modalidadeRaw.normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g,'');
            let tipoPagamento = '';
            if (modalidadeNorm.includes('debito') || modalidadeNorm.includes('deb')) tipoPagamento = 'Débito';
            else if (modalidadeNorm.includes('credito') || modalidadeNorm.includes('cred')) tipoPagamento = 'Crédito';
            else if (modalidadeNorm.includes('pix')) tipoPagamento = 'PIX';
            // apenas Débito ou Crédito no fluxo Cartões
            if (tipoPagamento !== 'Débito' && tipoPagamento !== 'Crédito') {
              // mostrar a linha que foi ignorada por modalidade
              console.debug('[Importar] Ignorando linha por modalidade inválida:', i, modalidadeRaw, row);
              continue;
            }

            const valorBruto = parseNumber(row[4]); // E
            const valorMDR = parseNumber(row[11]); // L

            const key = `${anoMes}||${tipoPagamento}`;
            if (!resumoPorMes[key]) resumoPorMes[key] = {receitaBruta:0, mdr:0, anoMes, source: 'cartao', tipoPagamento};
            resumoPorMes[key].receitaBruta += valorBruto;
            resumoPorMes[key].mdr += valorMDR;
            resumoPorMes[key].receitaLiquida = resumoPorMes[key].receitaBruta - resumoPorMes[key].mdr;
            totalVendas++;
          }
        }

        // Atualiza preview e salva
        preview.textContent = `${totalVendas} vendas em cartões processadas.`;
        tabelaPreview.innerHTML = '';
        let vendasResumo = JSON.parse(localStorage.getItem('vendasResumo')) || [];
        Object.entries(resumoPorMes).forEach(([key, valores]) => {
          vendasResumo = vendasResumo.filter(v => !(v.anoMes === valores.anoMes && v.source === 'cartao' && v.tipoPagamento === valores.tipoPagamento));
          vendasResumo.push({anoMes: valores.anoMes, receitaBruta: valores.receitaBruta, mdr: valores.mdr, receitaLiquida: valores.receitaLiquida, source: 'cartao', tipoPagamento: valores.tipoPagamento});
        });
        localStorage.setItem('vendasResumo', JSON.stringify(vendasResumo));
        console.log('[Importar] Processamento de cartões concluído. Total vendas:', totalVendas);
      } catch (err) {
        console.error('[Importar] Erro ao processar arquivos de cartões:', err);
        alert('Erro ao processar arquivos de cartões: ' + (err && err.message ? err.message : err));
      } finally {
        processarBtnCartao.dataset.loading = 'false';
        atualizarResumo();
        atualizarDashboardGraficos();
      }
      // também adiciona entradas detalhadas por venda (se for possível extrair)
      try {
        const detalhes = JSON.parse(localStorage.getItem('vendasDetalhadas')) || [];
        // tentativa de re-criar vendasDetalhadas a partir das linhas lidas (apenas quando possível)
        // (não modificamos se não houver dados)
        localStorage.setItem('vendasDetalhadas', JSON.stringify(detalhes));
      } catch(e){}
      atualizarResumo();
      atualizarDashboardGraficos();
  processarBtnCartao.dataset.loading = 'false';
  try { enhancePreviewTable(); } catch(e) { /* noop */ }
  alert(`Importação concluída: ${totalVendas} registros processados (cartões).`);
    });

    // Processar arquivo PIX (novo)
    processarBtnPix && processarBtnPix.addEventListener('click', async () => {
      if (!arquivosSelecionadosPix || arquivosSelecionadosPix.length === 0) return;
      processarBtnPix.dataset.loading = 'true';
      let resumoPorMes = {};
      let totalVendas = 0;
      for (const arquivo of arquivosSelecionadosPix) {
        const data = await arquivo.arrayBuffer();
        const workbook = XLSX.read(new Uint8Array(data), {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {header:1});
        for (let i = 1; i < json.length; i++) {
          let row = json[i];
          if (!row) continue;
          // Se a linha foi lida como uma única string (CSV com ;), dividir em colunas
          if (Array.isArray(row) && row.length === 1 && typeof row[0] === 'string' && row[0].includes(';')) {
            row = row[0].split(';').map(c => c === undefined || c === null ? '' : String(c).trim());
          }
          const dataRaw = row[0];
          const identificacao = row[9] !== undefined ? row[9] : row[10];
          const status = String((row[13] !== undefined ? row[13] : row[14] || row[14]) || '').trim().toLowerCase();
          const credito = String(row[14] !== undefined ? row[14] : row[15] || '').trim().toLowerCase();
          if (status !== 'approved') continue;
          let anoMes = 'Indefinido';
          if (typeof dataRaw === 'string' && dataRaw.includes('/')) {
            const datePart = dataRaw.split(' ')[0];
            const parts = datePart.split('/');
            if (parts.length === 3) {
              const dia = parts[0];
              const mes = parts[1];
              const ano = parts[2];
              anoMes = `${ano}/${mes.padStart(2,'0')}`;
            }
          } else if (!isNaN(dataRaw)) {
            const d = excelDateToJSDate(Number(dataRaw));
            const mes = String(d.getMonth()+1).padStart(2,'0');
            const ano = d.getFullYear();
            anoMes = `${ano}/${mes}`;
          }
          // agrupar por anoMes + tipoPagamento = 'PIX'
          const tipoPagamento = 'PIX';
          const key = `${anoMes}||${tipoPagamento}`;
          if (!resumoPorMes[key]) resumoPorMes[key] = {receitaBruta:0, mdr:0, anoMes, source: 'pix', tipoPagamento};
          const valorBruto = parseNumber(row[16] !== undefined ? row[16] : row[17]);
          const valorLiquido = parseNumber(row[21] !== undefined ? row[21] : row[22]);
          const valorMDR = valorBruto - valorLiquido;
          resumoPorMes[key].receitaBruta += valorBruto;
          resumoPorMes[key].mdr += valorMDR;
          resumoPorMes[key].receitaLiquida = resumoPorMes[key].receitaBruta - resumoPorMes[key].mdr;
          totalVendas++;
        }
      }
      // Atualiza preview e salva
      preview.textContent = `${totalVendas} vendas PIX processadas.`;
      tabelaPreview.innerHTML = '';
      let vendasResumo = JSON.parse(localStorage.getItem('vendasResumo')) || [];
      Object.entries(resumoPorMes).forEach(([key, valores]) => {
        vendasResumo = vendasResumo.filter(v => !(v.anoMes === valores.anoMes && v.source === 'pix' && v.tipoPagamento === valores.tipoPagamento));
        vendasResumo.push({anoMes: valores.anoMes, receitaBruta: valores.receitaBruta, mdr: valores.mdr, receitaLiquida: valores.receitaLiquida, source: 'pix', tipoPagamento: valores.tipoPagamento});
      });
      localStorage.setItem('vendasResumo', JSON.stringify(vendasResumo));
  processarBtnPix.dataset.loading = 'false';
  atualizarResumo();
  atualizarDashboardGraficos();
  try { enhancePreviewTable(); } catch(e) { /* noop */ }
  alert(`Importação PIX concluída: ${totalVendas} registros processados.`);
    });

    // Inicializa tabela resumo ao carregar
    atualizarResumo();
  </script>
</body>
</html>
